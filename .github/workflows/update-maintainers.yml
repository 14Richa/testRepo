# name: Update MAINTAINERS.yaml

# on:
#   pull_request:
#     types: [opened]
#     paths:
#       - 'CODEOWNERS'

# jobs:
#   update-maintainers:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v2
#         with:
#           fetch-depth: 0

#       - name: Setup Node.js
#         uses: actions/setup-node@v2
#         with:
#           node-version: '14'

#       - name: Install js-yaml
#         run: npm install js-yaml@3.14.1

#       - name: Get added codeowner
#         id: codeowner
#         run: |
#           ADDED_CODEOWNER=$(git diff origin/${{ github.base_ref }} -- CODEOWNERS | grep '^+' | grep -v '^\+\+ ' | grep -v '^-[^+]' | awk '{print $NF}' | tr -d '@')
#           echo "ADDED_CODEOWNER=$ADDED_CODEOWNER" >> $GITHUB_ENV
#           echo "Added Codeowner: $ADDED_CODEOWNER"

#       - name: Get repository name
#         id: get-repo-name
#         run: |
#           REPO_NAME=$(basename ${{ github.repository }})
#           echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
#           echo "Repository Name: $REPO_NAME"

#       - name: Update MAINTAINERS.yaml
#         if: env.ADDED_CODEOWNER && env.REPO_NAME
#         uses: actions/github-script@v6
#         with:
#           script: |
#             console.log("Updating MAINTAINERS.yaml with added codeowner");
#             const fs = require('fs');
#             const yaml = require('js-yaml');

#             const addedCodeowner = process.env.ADDED_CODEOWNER;

#             // Skip adding bot users
#             const excludedUsers = ['asyncapi-bot', 'asyncapi-bot-eve'];
#             if (excludedUsers.includes(addedCodeowner)) {
#               console.log('Skipping update for excluded user:', addedCodeowner);
#               process.exit(0);
#             }

#             const maintainers = yaml.safeLoad(fs.readFileSync('MAINTAINERS.yaml', 'utf8'));
#             const repoName = process.env.REPO_NAME;

#             const newMaintainer = maintainers.find(maintainer => maintainer.name === addedCodeowner);

#             if (!newMaintainer) {
#               const newMaintainer = {
#                 name: '',
#                 github: addedCodeowner,
#                 slack: '',
#                 availableForHire: false,
#                 company: '',
#                 isTscMember: false,
#                 repos: [repoName]
#               };

#               maintainers.push(newMaintainer);

#               const updatedYaml = yaml.safeDump(maintainers);
#               fs.writeFileSync('MAINTAINERS.yaml', updatedYaml);
#               console.log('MAINTAINERS.yaml updated with new maintainer:', addedCodeowner);
#             } else {
#               console.log('Maintainer', addedCodeowner, 'already exists in MAINTAINERS.yaml. Skipping update.');
#             }

#       - name: Print new maintainer.yaml
#         id: print-file
#         run: |
#           cat MAINTAINERS.yaml

      # - name: Commit and push changes
      #   run: |
      #     git config user.name "github-actions"
      #     git config user.email "github-actions@github.com"
      #     git add MAINTAINERS.yaml
      #     git commit -m "Update MAINTAINERS.yaml"
      #     git push origin HEAD:${{ github.base_ref }}


name: Compare CODEOWNERS

on:
  pull_request:
    types: [closed]
    paths:
      - 'CODEOWNERS'

jobs:
  compare-codeowners:
    if: github.event.pull_request.merged
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v2
        with:
          ref: main
          path: testRepo-main

      - name: Checkout one commit before last one
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: main
          path: testRepo

      - run: cd testRepo && git checkout HEAD^

      - name: Compare CODEOWNERS
        id: compare-codeowners
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            function extractGitHubUsernames(content) {
              const regex = /@([a-zA-Z0-9_-]+)/g;
              const matches = content.match(regex);
              if (!matches) {
                return [];
              }
              return matches.map(match => match.substr(1));
            }

            const mainCodeowners = fs.readFileSync('./testRepo-main/CODEOWNERS', 'utf8');
            const prCodeowners = fs.readFileSync('./testRepo/CODEOWNERS', 'utf8');

            const mainUsernames = extractGitHubUsernames(mainCodeowners);
            const prUsernames = extractGitHubUsernames(prCodeowners);

            const addedUsernames = prUsernames.filter(username => !mainUsernames.includes(username));
            const removedUsernames = mainUsernames.filter(username => !prUsernames.includes(username));

            console.log('Added Usernames:', addedUsernames);
            console.log('Removed Usernames:', removedUsernames);

            console.log(`ADDED_USERNAMES=${addedUsernames.join(', ')}`);
            console.log(`REMOVED_USERNAMES=${removedUsernames.join(', ')}`);
